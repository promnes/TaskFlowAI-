# ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… - System Architecture

## Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙƒÙ„ÙŠ (Overall Structure)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TELEGRAM BOT (Aiogram v3)             â”‚
â”‚                    Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                              â”‚
        â–¼                              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  HANDLERS   â”‚           â”‚  MIDDLEWARE      â”‚
   â”‚ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª   â”‚           â”‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª        â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                              â”‚
    â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   START     â”‚  â”‚ WALLET   â”‚  â”‚AFFILIATE â”‚  â”‚  ADMIN   â”‚
â”‚  Ø§Ù„Ù…Ø±Ø§Ø­Ù„   â”‚  â”‚Ù…Ø­ÙØ¸Ø©   â”‚  â”‚ÙˆÙƒÙ„Ø§Ø¡   â”‚  â”‚Ø¥Ø¯Ø§Ø±Ø©   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚             â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   DATABASE MODELS    â”‚
          â”‚   Ù†Ù…Ø§Ø°Ø¬ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚
    â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WALLET  â”‚  â”‚AFFILIATE â”‚  â”‚ PAYMENT  â”‚
â”‚Ù…Ø­ÙØ¸Ø©   â”‚  â”‚ÙˆÙƒÙ„Ø§Ø¡   â”‚  â”‚Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   DATABASE (SQLite)  â”‚
          â”‚   Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ø§Ù„Ø·Ø¨Ù‚Ø§Øª (Layers)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PRESENTATION LAYER (Telegram)       â”‚
â”‚         Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ - Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©            â”‚
â”‚  (Messages, Callbacks, Keyboards)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      HANDLER LAYER (Aiogram Routes)      â”‚
â”‚      Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª - Ø§Ù„ØªÙˆØ¬ÙŠÙ‡            â”‚
â”‚  (wallet, affiliate, admin, auth)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      BUSINESS LOGIC LAYER (Services)     â”‚
â”‚    Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ - Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª     â”‚
â”‚  (commission calc, user search, etc)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DATA ACCESS LAYER (SQLAlchemy)      â”‚
â”‚    Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø©       â”‚
â”‚  (Models, Queries, Transactions)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DATABASE LAYER (SQLite/PostgreSQL)  â”‚
â”‚       Ø·Ø¨Ù‚Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª                â”‚
â”‚   (Tables, Indexes, Relationships)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Flow)

### 1. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ (Deposit Flow)

```
User
  â”‚
  â”œâ”€ /start
  â”‚   â””â”€ Choose "ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ financial_handlerâ”‚
â”‚  Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø§Ù„ÙŠ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Select Company (Ø´Ø±ÙƒØ©)
         â”œâ”€ Select Currency (Ø¹Ù…Ù„Ø©)
         â”œâ”€ Enter Amount (Ù…Ø¨Ù„Øº)
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Wallet Model â”‚
    â”‚  Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­ÙØ¸Ø© â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ Create/Update Wallet
             â”œâ”€ Freeze Amount
             â”œâ”€ Create Transaction Record
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Database â”‚
        â”‚Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Affiliate    â”‚
        â”‚System        â”‚
        â”‚(Commission)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Ø¹Ù…Ù„ÙŠØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Affiliate Flow)

```
Marketer (Ø§Ù„Ù…Ø³ÙˆÙ‚)
  â”‚
  â”œâ”€ /start
  â”‚   â””â”€ Choose "ğŸ¤ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ affiliate_handlerâ”‚
â”‚   Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Join Program (Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…)
         â”‚   â””â”€ Create Affiliate Record
         â”‚       â””â”€ Generate Unique Code
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Affiliate    â”‚
    â”‚ Model        â”‚
    â”‚Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆÙƒÙŠÙ„ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ Store Affiliate Info
             â”œâ”€ Generate Referral Link
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Customer   â”‚
        â”‚   Clicks     â”‚
        â”‚ Referral Linkâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Commission   â”‚
            â”‚ Calculated   â”‚
            â”‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin Flow)

```
Admin
  â”‚
  â”œâ”€ /start
  â”‚   â””â”€ Choose "âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ admin_advanced   â”‚
â”‚ Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚    â”‚          â”‚          â”‚
    â–¼    â–¼    â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Search â”‚ Balance Edit â”‚ Currencyâ”‚
â”‚ Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ„    â”‚ ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯   â”‚ Ø¹Ù…Ù„Ø©  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Wallet Model â”‚
      â”‚  Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­ÙØ¸Ø© â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€ Update Balance
               â”œâ”€ Change Currency
               â”œâ”€ Log Changes
               â”‚
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Database â”‚
          â”‚Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Models)

### User (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     USER        â”‚
â”‚   Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              â”‚
â”‚ telegram_id     â”‚
â”‚ phone           â”‚
â”‚ preferred_curr. â”‚
â”‚ language        â”‚
â”‚ created_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚            â”‚             â”‚
    â–¼              â–¼            â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WALLET â”‚  â”‚AFFILIATEâ”‚  â”‚COMPLAINT â”‚  â”‚  OUTBOX    â”‚
â”‚Ù…Ø­ÙØ¸Ø© â”‚  â”‚ ÙˆÙƒÙŠÙ„   â”‚  â”‚ Ø´ÙƒÙˆÙ‰    â”‚  â”‚Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø§Ù„ÙŠØ©â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Wallet (Ø§Ù„Ù…Ø­ÙØ¸Ø©)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     WALLET       â”‚
â”‚    Ø§Ù„Ù…Ø­ÙØ¸Ø©      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id               â”‚
â”‚ user_id (FK)     â”‚
â”‚ currency         â”‚
â”‚ balance          â”‚
â”‚ frozen_amount    â”‚
â”‚ total_deposited  â”‚
â”‚ total_withdrawn  â”‚
â”‚ total_commission â”‚
â”‚ is_active        â”‚
â”‚ created_at       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WALLET_TRANSACTIONâ”‚
   â”‚  Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id               â”‚
   â”‚ wallet_id (FK)   â”‚
   â”‚ type             â”‚
   â”‚ amount           â”‚
   â”‚ reference_id     â”‚
   â”‚ status           â”‚
   â”‚ created_at       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Affiliate (Ø§Ù„ÙˆÙƒÙŠÙ„)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AFFILIATE        â”‚
â”‚    Ø§Ù„Ù…Ø³ÙˆÙ‚/Ø§Ù„ÙˆÙƒÙŠÙ„   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                   â”‚
â”‚ user_id (FK)         â”‚
â”‚ affiliate_code       â”‚
â”‚ affiliate_link       â”‚
â”‚ commission_type      â”‚
â”‚ commission_rate      â”‚
â”‚ total_referrals      â”‚
â”‚ active_referrals     â”‚
â”‚ total_commission_*   â”‚
â”‚ status               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚              â”‚
    â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AFFILIATE  â”‚ â”‚ AFFILIATE    â”‚ â”‚AFFILIATEâ”‚
â”‚ REFERRAL   â”‚ â”‚ COMMISSION   â”‚ â”‚PAYOUT  â”‚
â”‚ Ø¥Ø­Ø§Ù„Ø©      â”‚ â”‚ Ø¹Ù…ÙˆÙ„Ø©        â”‚ â”‚Ø¯ÙØ¹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Main Operations)

### 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ÙØ¸Ø© (View Wallet)
```
Handler: wallet.show_wallet()
  â”‚
  â”œâ”€ Get User ID
  â”œâ”€ Query: SELECT * FROM wallets WHERE user_id = ?
  â”œâ”€ Format Response (ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯)
  â”‚   â”œâ”€ Currency Emoji (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù…Ù„Ø©)
  â”‚   â”œâ”€ Balance (Ø§Ù„Ø±ØµÙŠØ¯)
  â”‚   â”œâ”€ Frozen Amount (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¬Ù…Ø¯)
  â”‚   â”œâ”€ Total Stats (Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©)
  â”‚
  â””â”€ Send to User
```

### 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Calculate Commission)
```
Handler: affiliate.calculate_commission()
  â”‚
  â”œâ”€ Get Affiliate Info
  â”œâ”€ Check Status (Ù†Ø´Ø·/Ù…Ø¹Ø·Ù„)
  â”œâ”€ Get Commission Rate (Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©)
  â”œâ”€ Get Transaction Amount (Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ù…Ù„ÙŠØ©)
  â”œâ”€ Calculate:
  â”‚   â””â”€ If PERCENTAGE: amount * rate / 100
  â”‚   â””â”€ If FIXED: rate
  â”‚
  â”œâ”€ Create Commission Record
  â””â”€ Return Amount
```

### 3. ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© (Change Currency)
```
Handler: admin_advanced.change_user_currency()
  â”‚
  â”œâ”€ Validate Admin (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
  â”œâ”€ Get User ID
  â”œâ”€ Get New Currency
  â”œâ”€ Validate Currency (ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù…Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©)
  â”œâ”€ Update: UPDATE users SET preferred_currency = ?
  â”œâ”€ Log Change (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±)
  â”‚
  â””â”€ Confirm to Admin
```

---

## Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Current Resources)

### Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª (Handlers)
- âœ… wallet.router - 230 lines
- âœ… affiliate.router - 290 lines
- âœ… admin_advanced.router - 320 lines

### Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Models)
- âœ… Wallet - 95 lines
- âœ… Affiliate - 170 lines
- âœ… PaymentMethod - 120 lines

### Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Utils)
- âœ… keyboards.py - +200 lines (Ù…Ø­Ø¯Ø«Ø©)

### Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
- **1,440+ Ø£Ø³Ø·Ø± Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯**
- **0 Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ØªØ¬Ù…ÙŠØ¹**
- **Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†ØªØ§Ø¬**

---

## Ø§Ù„Ø£Ù…Ø§Ù† (Security)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SECURITY LAYERS             â”‚
â”‚       Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚ 1. Authentication (Ø§Ù„ØªØ­Ù‚Ù‚)          â”‚
â”‚    â””â”€ Telegram User ID               â”‚
â”‚    â””â”€ Admin ID Validation           â”‚
â”‚                                      â”‚
â”‚ 2. Authorization (Ø§Ù„Ø¥Ø°Ù†)            â”‚
â”‚    â””â”€ Admin-Only Operations         â”‚
â”‚    â””â”€ User-Only Operations          â”‚
â”‚                                      â”‚
â”‚ 3. Data Encryption (Ø§Ù„ØªØ´ÙÙŠØ±)        â”‚
â”‚    â””â”€ Sensitive Fields              â”‚
â”‚    â””â”€ Transaction Logs              â”‚
â”‚                                      â”‚
â”‚ 4. Audit Trail (Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚)        â”‚
â”‚    â””â”€ Transaction History           â”‚
â”‚    â””â”€ Admin Actions                 â”‚
â”‚                                      â”‚
â”‚ 5. Rate Limiting (Ø­Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)      â”‚
â”‚    â””â”€ Per-User Limits               â”‚
â”‚    â””â”€ Per-Operation Limits          â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ø§Ù„Ø£Ø¯Ø§Ø¡ (Performance)

```
Optimization Strategies (Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†)
â”‚
â”œâ”€ Database Indexing (ÙÙ‡Ø±Ø³Ø© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©)
â”‚  â””â”€ user_id, currency, status
â”‚
â”œâ”€ Async/Await (Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©)
â”‚  â””â”€ Non-blocking Operations
â”‚
â”œâ”€ Query Optimization (ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª)
â”‚  â””â”€ Selective SELECT
â”‚  â””â”€ JOIN Optimization
â”‚
â”œâ”€ Caching (Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª)
â”‚  â””â”€ User Preferences
â”‚  â””â”€ Commission Rates
â”‚
â””â”€ Connection Pooling (ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª)
   â””â”€ AsyncSession Pool
```

---

## Ø§Ù„Ù‚Ø§Ø¨Ù„ÙŠØ© Ù„Ù„ØªÙˆØ³Ø¹ (Scalability)

```
Current (Ø§Ù„Ø­Ø§Ù„ÙŠ):
SQLite Database â†’ Single Bot Instance

Future (Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„):
PostgreSQL Database â†’ Multiple Bot Instances â†’ Load Balancer
                   â†’ Cache Layer (Redis)
                   â†’ Message Queue (RabbitMQ)
                   â†’ Analytics Engine
```

---

**Ø§Ù„Ø­Ø§Ù„Ø©: âœ… Ù…Ù†Ø¬Ø² ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„**
